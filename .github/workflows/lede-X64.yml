name: "æ„å»ºLEDE-X86X64å›ºä»¶"

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '40 16 */3 * *'  # æ¯ 3 å¤©åŒ—äº¬æ—¶é—´ 00:40

env:
  # â”€â”€â”€â”€â”€ æºç ä¸è„šæœ¬ â”€â”€â”€â”€â”€
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

  # â”€â”€â”€â”€â”€ ä¸Šä¼ /å‘å¸ƒé€‰é¡¹ â”€â”€â”€â”€â”€
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # â”€â”€â”€â”€â”€ æ„å»ºå‚æ•° â”€â”€â”€â”€â”€
  TZ: Asia/Shanghai
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: "800M"

jobs:
  build-firmware:
    name: æ„å»ºå›ºä»¶
    runs-on: ubuntu-22.04
    concurrency:
      group: lede-${{ github.ref }}
      cancel-in-progress: true

    steps:
    # 1ï¸âƒ£ è®°å½•å¼€å§‹æ—¶é—´
    - name: è®°å½•å¼€å§‹æ—¶é—´
      run: |
        echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"
        echo "RELEASE_TAG=$(date '+%Y.%m.%d-%H%M')" >> $GITHUB_ENV

    # 2ï¸âƒ£ æ£€å‡ºä»“åº“
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    # 3ï¸âƒ£ å‡†å¤‡æ„å»ºç¯å¢ƒ
    - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        sudo rm -rf /usr/share/{dotnet,man,doc,groff,info,lintian,linda,locale} \
                    /usr/local/lib/android /opt/ghc /usr/lib/jvm /usr/share/swift \
                    /usr/local/go /opt/hostedtoolcache/* /usr/share/az_*
        sudo docker system prune -af --volumes || true
        sudo apt-get -qq update
        sudo apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk \
          gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool \
          libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev \
          libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev uuid-dev libuuid1
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean

    # 4ï¸âƒ£ å…‹éš†æºç 
    - name: å…‹éš†æºç åˆ° /mnt
      run: |
        sudo mkdir -p /mnt/openwrt && sudo chown $USER:$USER /mnt/openwrt
        git clone --depth 30 "$REPO_URL" -b "$REPO_BRANCH" /mnt/openwrt
        ln -sf /mnt/openwrt "$GITHUB_WORKSPACE/openwrt"
        cd /mnt/openwrt && echo "SOURCE_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # 5ï¸âƒ£ é…ç½® ccache
    - name: è®¾ç½® ccache
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/.ccache
        key: ccache-${{ hashFiles('toolchain/**', 'include/**') }}
        restore-keys: ccache-

    # 6ï¸âƒ£ DL / Feeds / å·¥å…·é“¾ç¼“å­˜å‘½ä¸­
    - name: ç¼“å­˜ dl
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: dl-${{ hashFiles('feeds.conf.default') }}
        restore-keys: dl-

    - name: ç¼“å­˜ toolchain
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/staging_dir
        key: toolchain-${{ hashFiles('toolchain/**', 'include/**') }}
        restore-keys: toolchain-

    - name: ç¼“å­˜ feeds
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/feeds
        key: feeds-${{ hashFiles('feeds.conf.default') }}
        restore-keys: feeds-

    - name: ç¼“å­˜ host tools
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/build_dir/host
        key: hosttools-${{ hashFiles('include/**') }}
        restore-keys: hosttools-


    # 7ï¸âƒ£ è‡ªå®šä¹‰ feeds
    - name: åº”ç”¨è‡ªå®šä¹‰ feedså’Œconfig
      run: |
        [ -e files ] && cp "$GITHUB_WORKSPACE/files" /mnt/openwrt/files   || echo "::warning::æ²¡æœ‰å®šä¹‰ é…ç½®æ–‡ä»¶files"
        [ -f "$DIY_P1_SH" ] && chmod +x "$DIY_P1_SH" && "$GITHUB_WORKSPACE/$DIY_P1_SH" || echo "::notice::æ²¡æœ‰å®šä¹‰ é…ç½®æ–‡ä»¶DIY_P1_SH"
        [ -e $CONFIG_FILE ] && cp "$GITHUB_WORKSPACE/$CONFIG_FILE" /mnt/openwrt/.config || echo "::warning::æ²¡æœ‰å®šä¹‰ é…ç½®æ–‡ä»¶CONFIG_FILE"        
        cd /mnt/openwrt  && make defconfig
        sed -i 's/OpenWrt/Build${{ env.RELEASE_TAG }} @ OpenWrt/g' package/lean/default-settings/files/zzz-default-settings


    # 8ï¸âƒ£ æ›´æ–°å’Œå®‰è£… feedsï¼ˆå§‹ç»ˆæ‰§è¡Œï¼Œæ— æ¡ä»¶ï¼‰
    - name: æ›´æ–°å’Œå®‰è£… feeds
      run: |
        cd /mnt/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f
        [ -f "$GITHUB_WORKSPACE/$DIY_P2_SH" ] && chmod +x "$GITHUB_WORKSPACE/$DIY_P2_SH" && "$GITHUB_WORKSPACE/$DIY_P2_SH" || echo "::notice::æ²¡æœ‰å®šä¹‰ é…ç½®æ–‡ä»¶DIY_P2_SH"

    # 9ï¸âƒ£ ç”Ÿæˆä¸Šæ¸¸æ›´æ–°æ—¥å¿—
    - name: ç”Ÿæˆä¸Šæ¸¸æ›´æ–°æ—¥å¿—
      run: |
        cd /mnt/openwrt
        # æ‹‰å–æœ€æ–°æäº¤è®°å½•ï¼ˆå¤±è´¥ä¸é˜»æ–­ï¼‰
        git fetch --deepen=30 || true
        git -C feeds/packages fetch --deepen=30 || true
        git -C feeds/luci fetch --deepen=30 || true
        # è®¾ç½®å¤šè¡Œç¯å¢ƒå˜é‡ CHANGELOG_CONTENT
        {
        echo "CHANGELOG_CONTENT<<EOF"
        echo "ğŸ“¦ ä¸Šæ¸¸æ›´æ–°æ—¥å¿—"
        echo "##ğŸ”§ [lede ä¸»ä»“åº“](https://github.com/coolsnowwolf/lede)"
        git log --date=short --pretty="- [%ad] %s" --no-merges -n 15
        echo "##ğŸ“¦ [lede packages](https://github.com/coolsnowwolf/packages)"
        git -C feeds/packages log --date=short --pretty="- [%ad] %s" --no-merges -n 10
        echo "##ğŸ–¥ï¸ [lede luci](https://github.com/coolsnowwolf/luci)"
        git -C feeds/luci log --date=short --pretty="- [%ad] %s" --no-merges -n 10
        echo "EOF"
        } >> $GITHUB_ENV

    # 1ï¸âƒ£0ï¸âƒ£ ä¸‹è½½æºç ä¾èµ–
    - name: ä¸‹è½½æºç ä¾èµ–
      run: |
        cd /mnt/openwrt
        make defconfig
        for i in {1..3}; do
          if make download -j8; then break
          elif [ $i -eq 3 ]; then make download -j1 V=s
          else echo "::warning::ç¬¬ $i æ¬¡ä¾èµ–ä¸‹è½½å¤±è´¥ï¼Œ10 ç§’åé‡è¯•..." && sleep 10
          fi
        done
        find dl -size -1024c -exec rm -f {} \;

    # 1ï¸âƒ£1ï¸âƒ£ ç¼–è¯‘å›ºä»¶
    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd /mnt/openwrt
        mkdir -p logs
        echo "::notice::ccache ç»Ÿè®¡ï¼š" && ccache -s
        if ! make -j2 V=s 2>&1 | tee logs/build.log; then
          echo "::error::å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹"
          make -j1 V=s 2>&1 | tee -a logs/build.log || exit 1
        fi
        echo "::notice::ccache ç¼–è¯‘åï¼š" && ccache -s

    # 1ï¸âƒ£2ï¸âƒ£ ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ç¼–è¯‘æ—¥å¿—-${{ github.run_number }}
        path: /mnt/openwrt/logs/build.log
        retention-days: 3

    # 1ï¸âƒ£3ï¸âƒ£ è®°å½•ç»“æŸæ—¶é—´å’Œè€—æ—¶
    - name: è®°å½•ç»“æŸæ—¶é—´å’Œè€—æ—¶
      run: |
        echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"
        # å°† TIME0 å’Œ TIME1 è½¬æ¢ä¸º Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
        START_TIME=$(date -u -d "${{ env.TIME0 }}" +%s)
        END_TIME=$(date -u -d "${{ env.TIME1 }}" +%s)
        # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
        ELAPSED_SECONDS=$((END_TIME - START_TIME))
        # æ ¼å¼åŒ–ä¸º HHh MMm SSs
        ELAPSED_FORMATTED=$(printf "%02dh %02dm %02ds" $((ELAPSED_SECONDS/3600)) $((ELAPSED_SECONDS%3600/60)) $((ELAPSED_SECONDS%60)))
        # è¾“å‡ºç»“æœåˆ°ç¯å¢ƒå˜é‡
        echo "ELAPSED=$ELAPSED_FORMATTED" >> $GITHUB_ENV
        echo "::notice::æ€»è€—æ—¶: $ELAPSED"

    # 1ï¸âƒ£4ï¸âƒ£ æ•´ç†å›ºä»¶
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      run: |
        cd /mnt/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

    # 1ï¸âƒ£5ï¸âƒ£ ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: lede_X86X64å›ºä»¶-${{ github.run_number }}
        path: ${{ env.FIRMWARE_DIR }}

    # 1ï¸âƒ£6ï¸âƒ£ å‘å¸ƒ GitHub ç‰ˆæœ¬
    - name: å‘å¸ƒ GitHub ç‰ˆæœ¬
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: LEDE-X86X64-${{ env.RELEASE_TAG }}
        body: |
          ğŸ“¦ **ç¼–è¯‘æ—¶é—´æ®µ**  
          â° ä» **${{ env.TIME0 }}** åˆ° **${{ env.TIME1 }}**  
          ğŸ•’ **æ€»è€—æ—¶ï¼š${{ env.ELAPSED }}**
          ğŸ”„ **ä¸Šæ¸¸æ›´æ–°æ—¥å¿—**  
          ${{ env.CHANGELOG_CONTENT || 'æ— æ›´æ–°æ—¥å¿—å†…å®¹' }}
        files: |
          ${{ env.FIRMWARE_DIR }}/*

    # 1ï¸âƒ£7ï¸âƒ£ æ¸…ç†æ—§ç‰ˆæœ¬
    - name: æ¸…ç†æ—§ç‰ˆæœ¬
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: dev-drprasad/delete-older-releases@v0.3.4
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        keep_latest: 5
        delete_tags: true
