name: "æ„å»ºLEDE-X64å›ºä»¶"

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '40 16 */3 * *'   # æ¯ 3 å¤©åŒ—äº¬æ—¶é—´ 00:40

env:
  # â”€â”€â”€â”€â”€ æºç ä¸è„šæœ¬ â”€â”€â”€â”€â”€
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

  # â”€â”€â”€â”€â”€ ä¸Šä¼ /å‘å¸ƒé€‰é¡¹ â”€â”€â”€â”€â”€
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # â”€â”€â”€â”€â”€ æ„å»ºå‚æ•° â”€â”€â”€â”€â”€
  TZ: Asia/Shanghai
  MAKEFLAGS: "-j$(nproc) V=s"
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: "500M"

jobs:
  build-firmware:  
    name: æ„å»ºå›ºä»¶  
    runs-on: ubuntu-22.04
    concurrency:
      group: lede-${{ github.ref }}
      cancel-in-progress: true

    steps:
    # 1ï¸âƒ£ è®°å½•å¼€å§‹æ—¶é—´
    - name: è®°å½•å¼€å§‹æ—¶é—´
      run: |
        echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        # ç”Ÿæˆæ—¥æœŸæ—¶é—´æ ¼å¼çš„æ ‡ç­¾ (YYYY.MM.DD-HHMM)
        echo "RELEASE_TAG=$(date '+%Y.%m.%d-%H%M')" >> $GITHUB_ENV
        echo "ç”Ÿæˆå‘å¸ƒæ ‡ç­¾: $RELEASE_TAG"

    # 2ï¸âƒ£ å°†ä»“åº“ä»£ç æ‹‰å–åˆ°å·¥ä½œæµçš„ç¯å¢ƒä¸­
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    # 3ï¸âƒ£ å‡†å¤‡æ„å»ºç¯å¢ƒ
    - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        # æ¸…ç†ä¸éœ€è¦çš„è½¯ä»¶åŒ…å’Œç¼“å­˜
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
                    /usr/lib/jvm /usr/share/swift /usr/local/go \
                    /opt/hostedtoolcache/* /usr/share/az_* \
                    /usr/share/man /usr/share/doc /usr/share/groff /usr/share/info \
                    /usr/share/lintian /usr/share/linda /usr/share/locale
        
        # æ¸…ç† Docker ç¼“å­˜
        sudo docker system prune -af --volumes || true
        
        # å®‰è£…å¿…è¦ä¾èµ–
        sudo apt-get -qq update
        sudo apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev uuid-dev libuuid1
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean

    # 4ï¸âƒ£ å…‹éš†æºç 
    - name: å…‹éš†æºç åˆ°/mnt
      run: |
        sudo mkdir -p /mnt/openwrt && sudo chown $USER:$USER /mnt/openwrt
        git clone --depth 30 "$REPO_URL" -b "$REPO_BRANCH" /mnt/openwrt
        ln -sf /mnt/openwrt "$GITHUB_WORKSPACE/openwrt"
        # è®°å½•æºç ç‰ˆæœ¬ç”¨äºç¼“å­˜
        cd /mnt/openwrt
        echo "SOURCE_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # 5ï¸âƒ£ é…ç½®ccache
    - name: è®¾ç½®ccache
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/.ccache
        key: ccache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: ccache-${{ runner.os }}-

    - name: æ¢å¤DLç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: dl-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: dl-${{ runner.os }}-

    - name: æ¢å¤Feedsç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/feeds
        key: feeds-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: feeds-${{ runner.os }}-

    - name: å¯¹æ¯”ç¼–è¯‘å·¥å…·ç¯å¢ƒç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/staging_dir
        key: toolchain-${{ runner.os }}-${{ github.run_id }}
        restore-keys: toolchain-${{ runner.os }}-

    # 6ï¸âƒ£ é…ç½®ä¾èµ–ç¼“å­˜
    - uses: actions/cache@v4
      id: dl-cache
      name: è®¾ç½®ä¾èµ–ç¼“å­˜
      with:
        path: |
          /mnt/openwrt/dl
          /mnt/openwrt/build_dir/host
        key: ${{ runner.os }}-lede-${{ env.SOURCE_COMMIT }}-${{ hashFiles('include/**', 'package/**', 'target/**') }}
        restore-keys: |
          ${{ runner.os }}-lede-${{ env.SOURCE_COMMIT }}-
          ${{ runner.os }}-lede-

    # 7ï¸âƒ£ è‡ªå®šä¹‰feedsé…ç½®
    - name: åº”ç”¨è‡ªå®šä¹‰feeds
      run: |
        if [ -e "$FEEDS_CONF" ]; then
          mv "$FEEDS_CONF" /mnt/openwrt/feeds.conf.default
        else
          echo "::warning::æœªæ‰¾åˆ°feedsé…ç½®æ–‡ä»¶ $FEEDS_CONF"
        fi
        
        if [ -f "$DIY_P1_SH" ]; then
          chmod +x "$DIY_P1_SH"
          "$GITHUB_WORKSPACE/$DIY_P1_SH"
        else
          echo "::notice::æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SHï¼Œè·³è¿‡æ‰§è¡Œ"
        fi

    # 8ï¸âƒ£ æ›´æ–°feeds
    - name: æ›´æ–°å’Œå®‰è£…feeds
      run: |
        cd /mnt/openwrt
        ./scripts/feeds update -a
        
        # æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
        if [ "${{ steps.dl-cache.outputs.cache-hit }}" != 'true' ]; then
          echo "::notice::ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼ºåˆ¶é‡æ–°å®‰è£…æ‰€æœ‰feeds"
          ./scripts/feeds install -a -f
        else
          ./scripts/feeds install -a
        fi
        
        if [ -f "$GITHUB_WORKSPACE/$DIY_P2_SH" ]; then
          chmod +x "$GITHUB_WORKSPACE/$DIY_P2_SH"
          "$GITHUB_WORKSPACE/$DIY_P2_SH"
        else
          echo "::notice::æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ $DIY_P2_SHï¼Œè·³è¿‡æ‰§è¡Œ"
        fi

    # 9ï¸âƒ£ ç”Ÿæˆæ›´æ–°æ—¥å¿—
    - name: ç”Ÿæˆä¸Šæ¸¸æ›´æ–°æ—¥å¿—
      run: |
        cd /mnt/openwrt
        
        # æ‹‰å–å†å²è®°å½•ï¼ˆä¿æŒ30æ¡æ·±åº¦ï¼‰
        git fetch --deepen=30 || true
        git -C feeds/packages fetch --deepen=30 || true
        git -C feeds/luci fetch --deepen=30 || true
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p $GITHUB_WORKSPACE/changelog
        
        # è·å–å„ä»“åº“æ›´æ–°æ—¥å¿—
        LOG_LEDE=$(git log --date=short --pretty="- [%ad] %s" --no-merges -n 15)
        LOG_PKG=$(git -C feeds/packages log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/packages ä»“åº“ä¸å¯ç”¨")
        LOG_LUCI=$(git -C feeds/luci log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/luci ä»“åº“ä¸å¯ç”¨")
        
        # ç»„åˆå®Œæ•´çš„æ›´æ–°æ—¥å¿—
        {
          echo "ğŸ“¦ LEDE ä¸Šæ¸¸æ›´æ–°æ—¥å¿— (åˆ†æ”¯: $REPO_BRANCH)"
          echo
          echo "##ğŸ”§ [lede ä¸»ä»“åº“]( https://github.com/coolsnowwolf/lede )(æœ€è¿‘ 15 æ¡)"
          echo "$LOG_LEDE"
          echo
          echo "##ğŸ“¦ [packages ä»“åº“]( https://github.com/coolsnowwolf/packages ) (æœ€è¿‘ 10 æ¡)"
          echo "$LOG_PKG"
          echo
          echo "##ğŸ–¥ï¸ [luci ä»“åº“]( https://github.com/coolsnowwolf/luci ) (æœ€è¿‘ 10 æ¡)"
          echo "$LOG_LUCI"
        } > $GITHUB_WORKSPACE/changelog/complete_changelog.txt
        
        # ä¿å­˜æ—¥å¿—æ–‡ä»¶è·¯å¾„
        echo "CHANGELOG_FILE=$GITHUB_WORKSPACE/changelog/complete_changelog.txt" >> $GITHUB_ENV

    # 1ï¸âƒ£0ï¸âƒ£ ä¸‹è½½ä¾èµ–
    - name: ä¸‹è½½æºç ä¾èµ–
      run: |
        cd /mnt/openwrt
        make defconfig
        
        # å¸¦é‡è¯•æœºåˆ¶çš„ä¸‹è½½
        for i in {1..3}; do
          if make download -j8; then
            break
          elif [ $i -eq 3 ]; then
            make download -j1 V=s
          else
            echo "::warning::ä¾èµ–ä¸‹è½½å°è¯• $i å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•..."
            sleep 10
          fi
        done
        
        find dl -size -1024c -exec rm -f {} \;

    # 1ï¸âƒ£1ï¸âƒ£ ç¼–è¯‘å›ºä»¶
    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd /mnt/openwrt
        if ! make $MAKEFLAGS; then
          echo "::error::å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘"
          make -j1 V=s || exit 1
        fi

    # 1ï¸âƒ£2ï¸âƒ£ è®°å½•ç»“æŸæ—¶é—´
    - name: è®°å½•ç»“æŸæ—¶é—´å’Œè€—æ—¶
      run: |
        echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        START=$(date -d "$TIME0" +%s)
        END=$(date -d "$TIME1" +%s)
        ELAPSED_SEC=$((END - START))
        printf -v ELAPSED "%02dh %02dm %02ds" $((ELAPSED_SEC/3600)) $((ELAPSED_SEC%3600/60)) $((ELAPSED_SEC%60))
        echo "ELAPSED=$ELAPSED" >> $GITHUB_ENV

    # 1ï¸âƒ£3ï¸âƒ£ æ•´ç†å›ºä»¶
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      run: |
        cd /mnt/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

    # 1ï¸âƒ£4ï¸âƒ£ ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrtå›ºä»¶-${{ github.run_number }}
        path: ${{ env.FIRMWARE_DIR }}
        retention-days: 3

    # 1ï¸âƒ£5ï¸âƒ£ ä¸Šä¼ æ›´æ–°æ—¥å¿—
    - name: ä¸Šä¼ æ›´æ–°æ—¥å¿—
      uses: actions/upload-artifact@v4
      with:
        name: æ›´æ–°æ—¥å¿—-${{ github.run_number }}
        path: ${{ env.CHANGELOG_FILE }}
        retention-days: 0  # æ°¸ä¹…ä¿ç•™

    # 1ï¸âƒ£6ï¸âƒ£ å‘å¸ƒGitHubç‰ˆæœ¬
    - name: å‘å¸ƒGitHubç‰ˆæœ¬
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: æ„å»º #${{ github.run_number }} (è€—æ—¶ ${{ env.ELAPSED }})
        body: |
          ğŸ“¦ **ç¼–è¯‘æ—¶é—´æ®µ**  
          â° ä» **${{ env.TIME0 }}** åˆ° **${{ env.TIME1 }}**  
          ğŸ•’ **æ€»è€—æ—¶ï¼š${{ env.ELAPSED }}**
          
          ğŸ”„ **ä¸Šæ¸¸æ›´æ–°æ—¥å¿—**  
          [æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ### ä¸Šæ¸¸æ›´æ–°æ—¥å¿—é¢„è§ˆ
          $(cat ${{ env.CHANGELOG_FILE }})
        files: |
          ${{ env.FIRMWARE_DIR }}/*
          ${{ env.CHANGELOG_FILE }}

    # 1ï¸âƒ£7ï¸âƒ£ æ¸…ç†å†å²ç‰ˆæœ¬
    - name: æ¸…ç†æ—§ç‰ˆæœ¬
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: dev-drprasad/delete-older-releases@v0.3.4
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        keep_latest: 5
        delete_tags: true
