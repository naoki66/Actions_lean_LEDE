name: "构建LEDE-X64固件"

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '40 16 */3 * *'   # 每 3 天北京时间 00:40

env:
  # ───── 源码与脚本 ─────
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

  # ───── 上传/发布选项 ─────
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # ───── 构建参数 ─────
  TZ: Asia/Shanghai
  MAKEFLAGS: "-j$(nproc) V=s"
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: "500M"

jobs:
  build-firmware:  
    name: 构建固件  
    runs-on: ubuntu-22.04
    concurrency:
      group: lede-${{ github.ref }}
      cancel-in-progress: true

    steps:
    # 1️⃣ 记录开始时间
    - name: 记录开始时间
      run: |
        echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        # 生成日期时间格式的标签 (YYYY.MM.DD-HHMM)
        echo "RELEASE_TAG=$(date '+%Y.%m.%d-%H%M')" >> $GITHUB_ENV
        echo "生成发布标签: $RELEASE_TAG"

    # 2️⃣ 将仓库代码拉取到工作流的环境中
    - name: 检出仓库
      uses: actions/checkout@v4

    # 3️⃣ 准备构建环境
    - name: 准备构建环境
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        # 清理不需要的软件包和缓存
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
                    /usr/lib/jvm /usr/share/swift /usr/local/go \
                    /opt/hostedtoolcache/* /usr/share/az_* \
                    /usr/share/man /usr/share/doc /usr/share/groff /usr/share/info \
                    /usr/share/lintian /usr/share/linda /usr/share/locale
        
        # 清理 Docker 缓存
        sudo docker system prune -af --volumes || true
        
        # 安装必要依赖
        sudo apt-get -qq update
        sudo apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev uuid-dev libuuid1
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean

    # 4️⃣ 克隆源码
    - name: 克隆源码到/mnt
      run: |
        sudo mkdir -p /mnt/openwrt && sudo chown $USER:$USER /mnt/openwrt
        git clone --depth 30 "$REPO_URL" -b "$REPO_BRANCH" /mnt/openwrt
        ln -sf /mnt/openwrt "$GITHUB_WORKSPACE/openwrt"
        # 记录源码版本用于缓存
        cd /mnt/openwrt
        echo "SOURCE_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # 5️⃣ 配置ccache
    - name: 设置ccache
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/.ccache
        key: ccache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: ccache-${{ runner.os }}-

    - name: 恢复DL缓存
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/dl
        key: dl-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: dl-${{ runner.os }}-

    - name: 恢复Feeds缓存
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/feeds
        key: feeds-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: feeds-${{ runner.os }}-

    - name: 对比编译工具环境缓存
      uses: actions/cache@v4
      with:
        path: /mnt/openwrt/staging_dir
        key: toolchain-${{ runner.os }}-${{ github.run_id }}
        restore-keys: toolchain-${{ runner.os }}-

    # 6️⃣ 配置依赖缓存
    - uses: actions/cache@v4
      id: dl-cache
      name: 设置依赖缓存
      with:
        path: |
          /mnt/openwrt/dl
          /mnt/openwrt/build_dir/host
        key: ${{ runner.os }}-lede-${{ env.SOURCE_COMMIT }}-${{ hashFiles('include/**', 'package/**', 'target/**') }}
        restore-keys: |
          ${{ runner.os }}-lede-${{ env.SOURCE_COMMIT }}-
          ${{ runner.os }}-lede-

    # 7️⃣ 自定义feeds配置
    - name: 应用自定义feeds
      run: |
        if [ -e "$FEEDS_CONF" ]; then
          mv "$FEEDS_CONF" /mnt/openwrt/feeds.conf.default
        else
          echo "::warning::未找到feeds配置文件 $FEEDS_CONF"
        fi
        
        if [ -f "$DIY_P1_SH" ]; then
          chmod +x "$DIY_P1_SH"
          "$GITHUB_WORKSPACE/$DIY_P1_SH"
        else
          echo "::notice::未找到自定义脚本 $DIY_P1_SH，跳过执行"
        fi

    # 8️⃣ 更新feeds
    - name: 更新和安装feeds
      run: |
        cd /mnt/openwrt
        ./scripts/feeds update -a
        
        # 检查缓存恢复状态
        if [ "${{ steps.dl-cache.outputs.cache-hit }}" != 'true' ]; then
          echo "::notice::缓存未命中，强制重新安装所有feeds"
          ./scripts/feeds install -a -f
        else
          ./scripts/feeds install -a
        fi
        
        if [ -f "$GITHUB_WORKSPACE/$DIY_P2_SH" ]; then
          chmod +x "$GITHUB_WORKSPACE/$DIY_P2_SH"
          "$GITHUB_WORKSPACE/$DIY_P2_SH"
        else
          echo "::notice::未找到自定义脚本 $DIY_P2_SH，跳过执行"
        fi

    # 9️⃣ 生成更新日志
    - name: 生成上游更新日志
      run: |
        cd /mnt/openwrt
        
        # 拉取历史记录（保持30条深度）
        git fetch --deepen=30 || true
        git -C feeds/packages fetch --deepen=30 || true
        git -C feeds/luci fetch --deepen=30 || true
        
        # 创建日志目录
        mkdir -p $GITHUB_WORKSPACE/changelog
        
        # 获取各仓库更新日志
        LOG_LEDE=$(git log --date=short --pretty="- [%ad] %s" --no-merges -n 15)
        LOG_PKG=$(git -C feeds/packages log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/packages 仓库不可用")
        LOG_LUCI=$(git -C feeds/luci log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/luci 仓库不可用")
        
        # 组合完整的更新日志
        {
          echo "📦 LEDE 上游更新日志 (分支: $REPO_BRANCH)"
          echo
          echo "##🔧 [lede 主仓库]( https://github.com/coolsnowwolf/lede )(最近 15 条)"
          echo "$LOG_LEDE"
          echo
          echo "##📦 [packages 仓库]( https://github.com/coolsnowwolf/packages ) (最近 10 条)"
          echo "$LOG_PKG"
          echo
          echo "##🖥️ [luci 仓库]( https://github.com/coolsnowwolf/luci ) (最近 10 条)"
          echo "$LOG_LUCI"
        } > $GITHUB_WORKSPACE/changelog/complete_changelog.txt
        
        # 保存日志文件路径
        echo "CHANGELOG_FILE=$GITHUB_WORKSPACE/changelog/complete_changelog.txt" >> $GITHUB_ENV

    # 1️⃣0️⃣ 下载依赖
    - name: 下载源码依赖
      run: |
        cd /mnt/openwrt
        make defconfig
        
        # 带重试机制的下载
        for i in {1..3}; do
          if make download -j8; then
            break
          elif [ $i -eq 3 ]; then
            make download -j1 V=s
          else
            echo "::warning::依赖下载尝试 $i 失败，正在重试..."
            sleep 10
          fi
        done
        
        find dl -size -1024c -exec rm -f {} \;

    # 1️⃣1️⃣ 编译固件
    - name: 编译固件
      run: |
        cd /mnt/openwrt
        if ! make $MAKEFLAGS; then
          echo "::error::并行编译失败，尝试单线程编译"
          make -j1 V=s || exit 1
        fi

    # 1️⃣2️⃣ 记录结束时间
    - name: 记录结束时间和耗时
      run: |
        echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        START=$(date -d "$TIME0" +%s)
        END=$(date -d "$TIME1" +%s)
        ELAPSED_SEC=$((END - START))
        printf -v ELAPSED "%02dh %02dm %02ds" $((ELAPSED_SEC/3600)) $((ELAPSED_SEC%3600/60)) $((ELAPSED_SEC%60))
        echo "ELAPSED=$ELAPSED" >> $GITHUB_ENV

    # 1️⃣3️⃣ 整理固件
    - name: 整理固件文件
      id: organize
      run: |
        cd /mnt/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

    # 1️⃣4️⃣ 上传固件
    - name: 上传固件产物
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt固件-${{ github.run_number }}
        path: ${{ env.FIRMWARE_DIR }}
        retention-days: 3

    # 1️⃣5️⃣ 上传更新日志
    - name: 上传更新日志
      uses: actions/upload-artifact@v4
      with:
        name: 更新日志-${{ github.run_number }}
        path: ${{ env.CHANGELOG_FILE }}
        retention-days: 0  # 永久保留

    # 1️⃣6️⃣ 发布GitHub版本
    - name: 发布GitHub版本
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: 构建 #${{ github.run_number }} (耗时 ${{ env.ELAPSED }})
        body: |
          📦 **编译时间段**  
          ⏰ 从 **${{ env.TIME0 }}** 到 **${{ env.TIME1 }}**  
          🕒 **总耗时：${{ env.ELAPSED }}**
          
          🔄 **上游更新日志**  
          [查看完整更新日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ### 上游更新日志预览
          $(cat ${{ env.CHANGELOG_FILE }})
        files: |
          ${{ env.FIRMWARE_DIR }}/*
          ${{ env.CHANGELOG_FILE }}

    # 1️⃣7️⃣ 清理历史版本
    - name: 清理旧版本
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: dev-drprasad/delete-older-releases@v0.3.4
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      with:
        keep_latest: 5
        delete_tags: true
