#
# Build LEDEâ€‘X64  â€‘â€‘ åŒ…å«ç¼–è¯‘è€—æ—¶ & ä¸Šæ¸¸æ›´æ–°æ—¥å¿—
#

name: Buildâ€‘LEDEâ€‘X64

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '40 16 */3 * *'   # æ¯ 3 å¤©åŒ—äº¬æ—¶é—´ 00:40

env:
  # â”€â”€â”€â”€â”€ æºç ä¸è„šæœ¬ â”€â”€â”€â”€â”€
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

  # â”€â”€â”€â”€â”€ ä¸Šä¼ /å‘å¸ƒé€‰é¡¹ â”€â”€â”€â”€â”€
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # â”€â”€â”€â”€â”€ æ„å»ºå‚æ•° â”€â”€â”€â”€â”€
  TZ: Asia/Shanghai
  MAKEFLAGS: "-j$(nproc) V=s"
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: "500M"

jobs:
  build:
    runs-on: ubuntu-22.04
    concurrency:
      group: lede-${{ github.ref }}
      cancel-in-progress: true

    steps:
    # 1ï¸âƒ£ è®°å½•å¼€å§‹æ—¶é—´
    - name: Set start time
      run: |
        echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    # 2ï¸âƒ£ Checkout å½“å‰ä»“åº“
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # 3ï¸âƒ£ æ¸…ç†ç£ç›˜ & å®‰è£…ä¾èµ–
    - name: Prepare build environment
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
                    /usr/lib/jvm /usr/share/swift /usr/local/go \
                    /opt/hostedtoolcache/* /usr/share/az_* \
                    /usr/share/man /usr/share/doc /usr/share/groff /usr/share/info \
                    /usr/share/lintian /usr/share/linda /usr/share/locale
        sudo docker system prune -af --volumes
        sudo apt-get -qq update
        sudo apt-get -qq install -y build-essential clang flex bison g++ gawk \
             gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
             python3 unzip zlib1g-dev file wget rsync
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean

    # 4ï¸âƒ£ å…‹éš†æºç åˆ° /mntï¼ˆå‰©ä½™ç©ºé—´è¾ƒå¤§ï¼‰
    - name: Clone source to /mnt
      run: |
        sudo mkdir -p /mnt/openwrt && sudo chown $USER:$USER /mnt/openwrt
        git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" /mnt/openwrt
        ln -sf /mnt/openwrt "$GITHUB_WORKSPACE/openwrt"

    # 5ï¸âƒ£ ccache
    - uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-openwrt
        max-size: ${{ env.CCACHE_MAXSIZE }}

    # 6ï¸âƒ£ ç¼“å­˜ dl & host å·¥å…·é“¾
    - uses: actions/cache@v3
      with:
        path: |
          /mnt/openwrt/dl
          /mnt/openwrt/build_dir/host
        key: ${{ runner.os }}-lede-${{ hashFiles('include/**', 'package/**', 'target/**') }}
        restore-keys: |
          ${{ runner.os }}-lede-

    # 7ï¸âƒ£ è‡ªå®šä¹‰ feeds / è„šæœ¬
    - name: Apply custom feeds
      run: |
        [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" /mnt/openwrt/feeds.conf.default
        chmod +x "$DIY_P1_SH" "$DIY_P2_SH" || true
        "$GITHUB_WORKSPACE/$DIY_P1_SH"

    # 8ï¸âƒ£ æ›´æ–° feeds
    - name: Update & install feeds
      run: |
        cd /mnt/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        "$GITHUB_WORKSPACE/$DIY_P2_SH" || true

    # 9ï¸âƒ£ ç”Ÿæˆä¸Šæ¸¸æ›´æ–°æ—¥å¿—
    - name: Generate upstream changelog
      run: |
        cd /mnt/openwrt

        # ç¡®ä¿ä¸æ˜¯ shallow cloneï¼Œè·å–æœ€è¿‘ 30 æ¡å†å²
        git fetch --deepen=30 || true
        git -C feeds/packages fetch --deepen=30 || true
        git -C feeds/luci     fetch --deepen=30 || true

        LOG_LEDE=$(git log   --date=short --pretty="- [%ad] %s" --no-merges -n 10)
        LOG_PKG=$(git -C feeds/packages log --date=short --pretty="- [%ad] %s" --no-merges -n 10)
        LOG_LUCI=$(git -C feeds/luci     log --date=short --pretty="- [%ad] %s" --no-merges -n 10)

        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "### lede"   >> $GITHUB_ENV
        echo "$LOG_LEDE"  >> $GITHUB_ENV
        echo ""           >> $GITHUB_ENV
        echo "### packages" >> $GITHUB_ENV
        echo "$LOG_PKG"   >> $GITHUB_ENV
        echo ""           >> $GITHUB_ENV
        echo "### luci"   >> $GITHUB_ENV
        echo "$LOG_LUCI"  >> $GITHUB_ENV
        echo "EOF"        >> $GITHUB_ENV

    # ğŸ”Ÿ ä¸‹è½½ä¾èµ–
    - name: Download sources
      run: |
        cd /mnt/openwrt
        make defconfig
        make download -j8 || make download -j1 V=s
        find dl -size -1024c -exec rm -f {} \;

    # 11ï¸âƒ£ ç¼–è¯‘
    - name: Compile
      run: |
        cd /mnt/openwrt
        make $MAKEFLAGS || make -j1 V=s

    # 12ï¸âƒ£ è®°å½•ç»“æŸæ—¶é—´ & è€—æ—¶
    - name: Record end time & elapsed
      run: |
        echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        START=$(date -d "$TIME0" +%s)
        END=$(date -d "$TIME1" +%s)
        ELAPSED_SEC=$((END - START))
        H=$((ELAPSED_SEC / 3600))
        M=$(((ELAPSED_SEC % 3600) / 60))
        S=$((ELAPSED_SEC % 60))
        printf -v ELAPSED "%02dh %02dm %02ds" $H $M $S
        echo "ELAPSED=$ELAPSED" >> $GITHUB_ENV

    # 13ï¸âƒ£ æ•´ç†å›ºä»¶
    - name: Organize firmware
      id: organize
      run: |
        cd /mnt/openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

    # 14ï¸âƒ£ ä¸Šä¼ å›ºä»¶ (Artifact)
    - name: Upload firmware artifact
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-firmware-${{ github.run_number }}
        path: ${{ env.FIRMWARE_DIR }}
        retention-days: 3

    # 15ï¸âƒ£ å‘å¸ƒ Release
    - name: Publish GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}   # â† ä»…æ­¤ä¸€å¤„å£°æ˜
      with:
        tag_name: ${{ format('{0}', github.run_number) }}
        body: |
          ğŸ“¦ **ç¼–è¯‘æ—¶é—´æ®µ**  
          â° ä» **${{ env.TIME0 }}** åˆ° **${{ env.TIME1 }}**  
          ğŸ•’ **æ€»è€—æ—¶ï¼š${{ env.ELAPSED }}**

          ğŸ”„ **ä¸Šæ¸¸æ›´æ–°æ—¥å¿—ï¼ˆæœ€è¿‘ 10 æ¡ï¼‰**  
          ${{ env.CHANGELOG }}
        files: ${{ env.FIRMWARE_DIR }}/*

    # 16ï¸âƒ£ æ¸…ç†å†å² (å¯é€‰ï¼Œä¿æŒä¸å˜)
    - name: Delete older releases
      if: env.UPLOAD_RELEASE == 'true'
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 5
        delete_tags: true
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
