#
# Copyright (c) 2019â€‘2025
# Based on P3TERX <https://p3terx.com> Actionsâ€‘OpenWrt é¡¹ç›®
# MITÂ License
#

name: Buildâ€‘LEDEâ€‘X64

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ç¼–è¯‘æœŸé—´æ˜¯å¦å¼€å¯ SSH è°ƒè¯•ä¼šè¯ (true/false)'
        required: false
        default: 'false'
  schedule:
    # æ¯ 3 å¤©åŒ—äº¬æ—¶é—´ 00:40 è§¦å‘
    - cron: '40 16 */3 * *'

env:
  # â”€â”€â”€â”€â”€ æºç ä¸è„šæœ¬ â”€â”€â”€â”€â”€
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

  # â”€â”€â”€â”€â”€ ä¸Šä¼ åŠå‘å¸ƒé€‰é¡¹ â”€â”€â”€â”€â”€
  UPLOAD_BIN_DIR: 'false'
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # â”€â”€â”€â”€â”€ æ„å»ºå‚æ•° â”€â”€â”€â”€â”€
  TZ: Asia/Shanghai
  MAKEFLAGS: "-j$(nproc) V=s"
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: "500M"

jobs:
  build:
    runs-on: ubuntu-22.04
    concurrency:
      group: lede-${{ github.ref }}
      cancel-in-progress: true

    steps:
      # 1ï¸âƒ£Â ç­¾å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2ï¸âƒ£Â é‡Šæ”¾ç£ç›˜ + å®‰è£…ä¾èµ–
      - name: Prepare build environment
        env: { DEBIAN_FRONTEND: noninteractive }
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
                      /usr/lib/jvm  /usr/share/swift /usr/local/go \
                      /opt/hostedtoolcache/* /usr/share/az_* \
                      /usr/share/man /usr/share/doc /usr/share/groff /usr/share/info \
                      /usr/share/lintian /usr/share/linda /usr/share/locale
          sudo docker system prune -af --volumes
          sudo apt-get -qq update
          sudo apt-get -qq install -y build-essential clang flex bison g++ gawk \
               gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
               python3 unzip zlib1g-dev file wget rsync
          sudo apt-get -qq autoremove --purge
          sudo apt-get -qq clean

      # 3ï¸âƒ£Â å…‹éš†æºç åˆ° /mntï¼ˆå‰©ä½™ç©ºé—´å¤§ï¼‰
      - name: Clone source to /mnt
        run: |
          echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          sudo mkdir -p /mnt/openwrt && sudo chown $USER:$USER /mnt/openwrt
          git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" /mnt/openwrt
          ln -sf /mnt/openwrt "$GITHUB_WORKSPACE/openwrt"

      # 4ï¸âƒ£Â æ¢å¤ / ä¿å­˜Â ccache
      - uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-openwrt
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # 5ï¸âƒ£Â æ¢å¤ä¸‹è½½æ–‡ä»¶ä¸å·¥å…·é“¾ç¼“å­˜
      - uses: actions/cache@v3
        with:
          path: |
            /mnt/openwrt/dl
            /mnt/openwrt/build_dir/host
          key: ${{ runner.os }}-lede-${{ hashFiles('include/**', 'package/**', 'target/**') }}
          restore-keys: |
            ${{ runner.os }}-lede-

      # 6ï¸âƒ£Â è‡ªå®šä¹‰è„šæœ¬ & feeds
      - name: Apply custom feeds
        run: |
          [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" /mnt/openwrt/feeds.conf.default
          chmod +x "$DIY_P1_SH" "$DIY_P2_SH" || true
          "$GITHUB_WORKSPACE/$DIY_P1_SH"

      - name: Update & install feeds
        run: |
          cd /mnt/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          "$GITHUB_WORKSPACE/$DIY_P2_SH" || true

      # 7ï¸âƒ£Â ä¸‹è½½æºç åŒ…
      - name: Download sources
        run: |
          cd /mnt/openwrt
          make defconfig
          make download -j8 || make download -j1 V=s
          find dl -size -1024c -exec rm -f {} \;

      # 8ï¸âƒ£Â ç¼–è¯‘
      - name: Compile
        run: |
          cd /mnt/openwrt
          make $MAKEFLAGS || make -j1 V=s
          echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      # 9ï¸âƒ£Â æ•´ç†è¾“å‡º
      - name: Organize firmware
        id: organize
        run: |
          cd /mnt/openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV

      # ğŸ”ŸÂ å¯é€‰ï¼šæ‰“å¼€ SSH è°ƒè¯•
      - name: Debug via SSH
        if: github.event.inputs.ssh == 'true'
        uses: mxschmitt/action-tmate@v3

      # 11Â ä¸Šä¼ å›ºä»¶Â (Artifacts)
      - name: Upload firmware artifact
        if: env.UPLOAD_FIRMWARE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-firmware-${{ github.run_number }}
          path: ${{ env.FIRMWARE_DIR }}
          retention-days: 3
          
       # 12 è®¡ç®—ç¼–è¯‘æ—¶é•¿ (åœ¨ Publish GitHub Release ä¹‹å‰)
      - name: Calculate elapsed time
        run: |
          # æŠŠ ISO æ ¼å¼æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³
          START_TS=$(date -d "${TIME0}" +%s)
          END_TS=$(date -d "${TIME1}" +%s)
          ELAPSED_SEC=$((END_TS - START_TS))

          # è®¡ç®— h:m:s
          H=$((ELAPSED_SEC / 3600))
          M=$(((ELAPSED_SEC % 3600) / 60))
          S=$((ELAPSED_SEC % 60))
          printf -v ELAPSED "%02dh %02dm %02ds" "$H" "$M" "$S"

          # å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤å¼•ç”¨
          echo "ELAPSED=${ELAPSED}" >> $GITHUB_ENV    

      # 13Â åˆ›å»º Release å¹¶ä¸Šä¼ 
      - name: Publish GitHub Release
        if: env.UPLOAD_RELEASE == 'true' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}   # â† ä»…æ­¤ä¸€å¤„å£°æ˜ï¼Œé¿å…å†²çª
        with:
          tag_name: ${{ format('{0}', github.run_number) }}
          body: |
            ä» **${{ env.TIME0 }}** åˆ° **${{ env.TIME1 }}** ç¼–è¯‘å®Œæˆã€‚
            æ€»è€—æ—¶ **${{ env.ELAPSED }}**
          files: ${{ env.FIRMWARE_DIR }}/*

      # 14Â åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œ
      - name: Delete workflow runs (keep 3 / 1Â day)
        uses: naoki66/delete-workflow-runs@main
        with:
          token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
          retain_days: 1
          keep_minimum_runs: 3

      # 15Â åˆ é™¤æ—§ Releases
      - name: Delete older releases (keep 5)
        if: env.UPLOAD_RELEASE == 'true'
        uses: dev-drprasad/delete-older-releases@v1
        with:
          keep_latest: 5
          delete_tags: true
          token: ${{ secrets.ACTIONS_TRIGGER_PAT }}

      # 16Â æ¸…ç† 7Â å¤©å‰åˆ¶å“
      - name: Remove artifacts older than 7Â days
        uses: c-hive/gha-remove-artifacts@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          age: '7 days'
          skip-tags: true
          skip-recent: 3
